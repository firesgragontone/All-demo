[TOC]

## 1.FastDFS的文件ID中可以反解出哪些字段？ 

文件ID中除了包含group name和存储路径外，文件名中可以反解出如下几个字段：  

​	1）文件创建时间（unix时间戳，32位整数）  	

​	2）文件大小  

​	3）上传到的源storage server IP地址（32位整数）  

​	4）文件crc32校验码  

​	5）随机数（这个字段用来避免文件重名）

## 2.文件下载流程

![img](https://images2017.cnblogs.com/blog/273387/201801/273387-20180111162544441-1355709714.png)

文件下载的步骤可以是：

> \1. client询问tracker下载文件的storage，参数为文件标识（组名和文件名）。
> \2. tracker返回一台可用的storage。
> \3. client直接和storage通讯完成文件下载。



## 3.文件上传的流程

![img](https://images2017.cnblogs.com/blog/273387/201801/273387-20180111161630691-1086451455.png)

　　1.client先向Tracker进行询问，

​        2.Tracker查看一下登记信息之后，告诉Client哪个storage当前空闲，Tracker会把IP和端口号都返回给Client

​        3.Client在拿到IP和端口号之后，便不再需要通过Tracker，直接便向Storage进行上传图片

​         4.Storage在保存图片的同时，会向Tracker进行汇报，告诉Tracker它当前是否还留有剩余空间，以及剩余空间大小。

​         5.汇报完之后，Storage将服务器上存储图片的地址返回给Client，Client可以拿着这个地址进行访问图片。

说得更加细致一点，客户端上传文件后存储服务器将文件ID返回给客户端，此文件ID用于以后访问该文件的索引信息。文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名，如下所示：![img](https://images2017.cnblogs.com/blog/273387/201801/273387-20180111161829754-464087582.png)

组名：文件上传后所在的storage组名称，在文件上传成功后由storage服务器返回，需要客户端自行保存。
虚拟磁盘路径：storage配置的虚拟路径，与磁盘选项store_path*对应。如果配置了store_path0则是M00，如果配置了store_path1则是M01，以此类推。
数据两级目录：storage服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。
文件名：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器IP地址、文件创建时间戳、文件大小、随机数和文件拓展名等信息。